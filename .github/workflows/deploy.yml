name: ğŸš€ Deploy Depth Studio to Firebase

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]

env:
  FIREBASE_PROJECT_ID: depth-studio

jobs:
  # ===========================================
  # ğŸ” Job 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©
  # ===========================================
  security-check:
    name: ğŸ›¡ï¸ Security & Environment Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # ÙØ­Øµ consistency Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ØµÙŠØ¨
    - name: ğŸ” Check Dependency Consistency
      run: |
        echo "ğŸ” Checking package.json and package-lock.json consistency..."
        npm install --dry-run || echo "âš ï¸ Dependencies are inconsistent! package-lock.json will be regenerated."

    # ØªÙ†ØµÙŠØ¨ dependencies Ù…Ù† Ø§Ù„Ù€ root (npm workspaces)
    - name: ğŸ“¦ Install Dependencies (Workspaces)
      run: |
        npm ci
        echo "âœ… All workspace dependencies installed"

    # Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Service Account Key
    - name: ğŸ”‘ Setup Firebase Service Account
      run: |
        mkdir -p backend/keys
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" > backend/keys/serviceAccountKey.json
        echo "âœ… Firebase Service Account Key created"

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ÙÙŠ Backend
    - name: ğŸ” Validate Backend Environment
      env:
        NODE_ENV: production
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        GOOGLE_APPLICATION_CREDENTIALS: ./backend/keys/serviceAccountKey.json
      run: |
        npm run --workspace=backend validate-env || echo "âš ï¸ Backend validation skipped (script may not exist)"

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Frontend Environment ÙˆØ¨Ù†Ø§Ø¡Ù‡
    - name: ğŸ” Validate Frontend Environment  
      env:
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: depth-studio.firebaseapp.com
        NEXT_PUBLIC_FIREBASE_DATABASE_URL: https://depth-studio-default-rtdb.firebaseio.com
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: depth-studio.firebasestorage.app
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
        NEXT_PUBLIC_FIRESTORE_DATABASE_ID: depth-production
      run: |
        npm run --workspace=frontend build

    # ÙØ­Øµ Ø£Ù…Ù†ÙŠ Ù„Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©
    - name: ğŸ•µï¸ Check for exposed secrets
      run: |
        echo "ğŸ” Checking for exposed API keys or secrets..."
        if grep -r "AIza[0-9A-Za-z\\-_]{35}" --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" .; then
          echo "âŒ Found exposed Firebase API keys in code!"
          exit 1
        fi
        if grep -r "firebase-adminsdk" --include="*.ts" --include="*.js" .; then
          echo "âŒ Found service account references in code!"
          exit 1
        fi
        echo "âœ… No exposed secrets found"

  # ===========================================
  # ğŸ§ª Job 2: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
  # ===========================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # ØªÙ†ØµÙŠØ¨ dependencies Ù…Ù† Ø§Ù„Ù€ root
    - name: ğŸ“¦ Install Dependencies (Workspaces)
      run: |
        npm ci
        echo "âœ… All workspace dependencies installed"

    # Ø§Ø®ØªØ¨Ø§Ø± Backend
    - name: ğŸ§ª Test Backend
      run: |
        npm run --workspace=backend test || echo "âš ï¸ Backend tests skipped (script may not exist)"

    # Ø§Ø®ØªØ¨Ø§Ø± Frontend  
    - name: ğŸ§ª Test Frontend
      run: |
        npm run --workspace=frontend test || echo "âš ï¸ Frontend tests skipped (script may not exist)"

  # ===========================================
  # ğŸš€ Job 3: Ø§Ù„Ù†Ø´Ø± Ù„Ù„Ø¥Ù†ØªØ§Ø¬
  # ===========================================
  deploy:
    name: ğŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    needs: [security-check, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # ØªÙ†ØµÙŠØ¨ dependencies Ù…Ù† Ø§Ù„Ù€ root
    - name: ğŸ“¦ Install Dependencies (Workspaces)
      run: |
        npm ci
        echo "âœ… All workspace dependencies installed"

    # Ø¥Ø¹Ø¯Ø§Ø¯ Firebase CLI
    - name: ğŸ”§ Setup Firebase CLI
      run: |
        npm install -g firebase-tools
        echo "âœ… Firebase CLI installed"

    # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ù…Ø§Ù†
    - name: ğŸ”‘ Setup Production Secrets
      run: |
        mkdir -p backend/keys
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" > backend/keys/serviceAccountKey.json
        echo "âœ… Production secrets configured"

    # Ø¨Ù†Ø§Ø¡ Types Ø£ÙˆÙ„Ø§Ù‹
    - name: ğŸ—ï¸ Build Types
      run: |
        npm run --workspace=types build
        echo "âœ… Types workspace built successfully"

    # Ø¨Ù†Ø§Ø¡ Backend
    - name: ğŸ”¨ Build Backend
      env:
        NODE_ENV: production
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        npm run --workspace=backend build
        echo "âœ… Backend build completed"

    # Ø¨Ù†Ø§Ø¡ ÙˆØªØµØ¯ÙŠØ± Frontend Ù„Ù„Ù€ static hosting
    - name: ğŸ”¨ Build & Export Frontend
      env:
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: depth-studio.firebaseapp.com
        NEXT_PUBLIC_FIREBASE_DATABASE_URL: https://depth-studio-default-rtdb.firebaseio.com
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: depth-studio.firebasestorage.app
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
        NEXT_PUBLIC_FIRESTORE_DATABASE_ID: depth-production
      run: |
        npm run --workspace=frontend build
        echo "âœ… Frontend build and export completed"

    # Ù†Ø´Ø± Ø¥Ù„Ù‰ Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Service Account
    - name: ğŸš€ Deploy to Firebase
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ./backend/keys/serviceAccountKey.json
      run: |
        firebase deploy --project ${{ env.FIREBASE_PROJECT_ID }}
        echo "âœ… Deployment completed successfully!"

    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
    - name: ğŸ§¹ Cleanup sensitive files
      run: |
        rm -f backend/keys/serviceAccountKey.json
        echo "âœ… Sensitive files cleaned up"

  # ===========================================
  # ğŸ“Š Job 4: Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
  # ===========================================
  notify:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: ğŸ“¢ Success Notification
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Frontend: https://depth-studio.web.app"
        echo "âš¡ Functions: https://us-central1-depth-studio.cloudfunctions.net"
        echo "ğŸ“Š Console: https://console.firebase.google.com/project/depth-studio" 