<template>
  <v-container fluid class="pa-0">
    <v-row no-gutters justify="center" align="center" style="min-height: 100vh;">
      <v-col cols="12" sm="10" md="8" lg="6" xl="5">
        <v-card 
          class="mx-auto pending-card" 
          :max-width="600"
          elevation="24"
          rounded="xl"
        >
          <div class="card-header">
            <v-img
              src="/logo-depth-studio.png"
              alt="Depth Studio"
              height="50"
              width="180"
              contain
              class="mx-auto mb-4"
            />
            <h1 class="text-h4 font-weight-bold text-center mb-2">
              Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            </h1>
            <p class="text-center text-medium-emphasis mb-6">
              Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ù†Ø¶Ù…Ø§Ù…Ùƒ Ù„ÙØ±ÙŠÙ‚ Depth Studio
            </p>
          </div>

          <v-card-text class="pa-8 text-center">
            <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div class="icon-container mb-6">
              <v-icon size="120" color="warning" class="pending-icon">
                mdi-clock-outline
              </v-icon>
            </div>

            <!-- Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <h2 class="text-h5 font-weight-bold mb-4">
              ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            </h2>
            
            <p class="text-h6 mb-6 text-medium-emphasis">
              ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ‡Ùˆ Ø§Ù„Ø¢Ù† Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
            </p>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
            <v-alert type="info" variant="outlined" class="text-start mb-6">
              <div class="d-flex align-center mb-3">
                <v-icon start>mdi-information</v-icon>
                <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©:</strong>
              </div>
              <ul class="pa-0 ma-0">
                <li class="mb-2">â±ï¸ <strong>ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</strong> Ø¹Ø§Ø¯Ø© Ù…Ù† 24-48 Ø³Ø§Ø¹Ø©</li>
                <li class="mb-2">ğŸ“§ <strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</strong> Ø³ØªØªÙ„Ù‚Ù‰ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙˆØ± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</li>
                <li class="mb-2">ğŸ”’ <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</strong> Ù…Ø­ÙÙˆØ¸ ÙˆØ¢Ù…Ù† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                <li>âœ… <strong>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:</strong> Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</li>
              </ul>
            </v-alert>

            <!-- Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
            <v-card variant="outlined" class="mb-6">
              <v-card-title class="text-h6 text-center">
                <v-icon start>mdi-timeline</v-icon>
                Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
              </v-card-title>
              <v-card-text>
                <v-stepper 
                  v-model="currentStep" 
                  alt-labels 
                  non-linear
                  class="elevation-0"
                >
                  <v-stepper-header>
                    <v-stepper-item
                      :complete="true"
                      step="1"
                      title="Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
                    />
                    <v-divider />
                    <v-stepper-item
                      :complete="true"
                      step="2"
                      title="Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±"
                    />
                    <v-divider />
                    <v-stepper-item
                      :complete="false"
                      step="3"
                      title="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"
                      color="warning"
                    />
                    <v-divider />
                    <v-stepper-item
                      :complete="false"
                      step="4"
                      title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨"
                    />
                  </v-stepper-header>
                </v-stepper>
              </v-card-text>
            </v-card>

            <!-- Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
            <div class="actions-section">
              <h3 class="text-h6 mb-4">Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ù†ØŸ</h3>
              
              <v-row class="mb-4">
                <v-col cols="12" md="6">
                  <v-btn
                    color="primary"
                    variant="outlined"
                    size="large"
                    block
                    @click="goToLogin"
                    rounded="lg"
                  >
                    <v-icon start>mdi-login</v-icon>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                  </v-btn>
                </v-col>
                
                <v-col cols="12" md="6">
                  <v-btn
                    color="grey"
                    variant="outlined"
                    size="large"
                    block
                    @click="refreshStatus"
                    :loading="isRefreshing"
                    rounded="lg"
                  >
                    <v-icon start>mdi-refresh</v-icon>
                    ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                  </v-btn>
                </v-col>
              </v-row>

              <!-- ğŸš€ Enterprise-Level Sign Out Option -->
              <v-row class="mb-4">
                <v-col cols="12">
                  <v-btn
                    color="error"
                    variant="outlined"
                    size="large"
                    block
                    @click="handleSignOut"
                    rounded="lg"
                    prepend-icon="mdi-logout"
                  >
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙƒØ§Ù…Ù„
                  </v-btn>
                  <p class="text-caption text-center mt-2 text-medium-emphasis">
                    Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                  </p>
                </v-col>
              </v-row>

              <!-- ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… -->
              <v-divider class="my-6" />
              
              <div class="contact-section">
                <p class="text-body-2 text-medium-emphasis mb-3">
                  <v-icon start size="16">mdi-help-circle</v-icon>
                  ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ùˆ Ù„Ø¯ÙŠÙƒ Ø§Ø³ØªÙØ³Ø§Ø±ØŸ
                </p>
                
                <v-btn
                  color="info"
                  variant="text"
                  @click="contactSupport"
                  size="small"
                >
                  <v-icon start>mdi-email</v-icon>
                  ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…
                </v-btn>
              </div>
            </div>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <!-- Snackbar Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª -->
    <v-snackbar
      v-model="showSnackbar"
      :color="snackbarColor"
      timeout="3000"
      top
    >
      {{ snackbarMessage }}
      <template v-slot:actions>
        <v-btn
          variant="text"
          @click="showSnackbar = false"
        >
          Ø¥ØºÙ„Ø§Ù‚
        </v-btn>
      </template>
    </v-snackbar>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import { useAuth } from '@/composables/useAuth'
import { db } from '@/firebase/config'
import { doc, getDoc } from 'firebase/firestore'

// === Router ÙˆComposables ===
const router = useRouter()
const { userProfile, trackUserAction, signOut } = useAuth()

// === Reactive Data ===
const currentStep = ref(3)
const isRefreshing = ref(false)
const showSnackbar = ref(false)
const snackbarMessage = ref('')
const snackbarColor = ref('info')
const currentStatus = ref('pending_approval')
const userRole = ref('pending')

// === Methods ===
const goToLogin = () => {
  // ğŸ¯ Track user intent for enterprise navigation
  trackUserAction('navigate_to_login', '/auth/login')
  console.log('ğŸ‘¤ User explicitly requested navigation to login')
  
  // Small delay to ensure intent is tracked
  setTimeout(() => {
    router.push('/auth/login')
  }, 50)
}

const handleSignOut = async () => {
  try {
    // ğŸ¯ Track sign out intent
    trackUserAction('sign_out', '/')
    console.log('ğŸ‘¤ User explicitly requested sign out')
    
    await signOut()
    console.log('âœ… User successfully signed out')
  } catch (error) {
    console.error('âŒ Error during sign out:', error)
    snackbarMessage.value = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'
    snackbarColor.value = 'error'
    showSnackbar.value = true
  }
}

const refreshStatus = async () => {
  if (!userProfile.value?.uid) return
  
  try {
    isRefreshing.value = true
    
    // Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Firestore
    const userDoc = await getDoc(doc(db, 'users', userProfile.value.uid))
    
    if (userDoc.exists()) {
      const userData = userDoc.data()
      
      if (userData.status === 'active') {
        snackbarMessage.value = 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...'
        snackbarColor.value = 'success'
        showSnackbar.value = true
        
        // ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        setTimeout(() => {
          switch (userData.primary_role) {
            case 'photographer':
              router.push('/photographer/dashboard')
              break
            case 'brand_coordinator':
              router.push('/brand-coordinator/dashboard')
              break
            case 'marketing_coordinator':
              router.push('/marketing-coordinator/dashboard')
              break
            default:
              router.push('/dashboard')
          }
        }, 2000)
        
      } else if (userData.status === 'rejected') {
        snackbarMessage.value = 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.'
        snackbarColor.value = 'error'
        showSnackbar.value = true
        
      } else {
        snackbarMessage.value = 'Ø·Ù„Ø¨Ùƒ Ù…Ø§ Ø²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.'
        snackbarColor.value = 'info'
        showSnackbar.value = true
      }
    } else {
      snackbarMessage.value = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨.'
      snackbarColor.value = 'error'
      showSnackbar.value = true
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:', error)
    snackbarMessage.value = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'
    snackbarColor.value = 'error'
    showSnackbar.value = true
  } finally {
    isRefreshing.value = false
  }
}

const contactSupport = () => {
  // ÙØªØ­ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ù†Ø§ÙØ°Ø© ØªÙˆØ§ØµÙ„
  window.open('mailto:support@depthstudio.com?subject=Ø§Ø³ØªÙØ³Ø§Ø± Ø­ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', '_blank')
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙˆØ±ÙŠØ§Ù‹
const refreshUserData = async () => {
  if (!userProfile.value?.uid) return
  
  try {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...')
    const userDoc = await getDoc(doc(db, 'users', userProfile.value.uid))
    
    if (userDoc.exists()) {
      const userData = userDoc.data()
      currentStatus.value = userData.status || 'pending_approval'
      userRole.value = userData.primary_role || 'pending'
      
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
        status: currentStatus.value,
        role: userRole.value
      })
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
      if (currentStatus.value === 'active') {
        console.log('ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨! Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...')
        setTimeout(() => {
          // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
          if (userRole.value === 'photographer') {
            router.push('/photographer/dashboard')
          } else if (userRole.value === 'brand_coordinator') {
            router.push('/brand-coordinator/dashboard')
          } else if (userRole.value === 'marketing_coordinator') {
            router.push('/marketing-coordinator/dashboard')
          } else {
            router.push('/dashboard')
          }
        }, 2000)
      }
    }
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error)
  }
}

// === Lifecycle ===
onMounted(() => {
  console.log('ğŸ“‹ ØµÙØ­Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userProfile.value?.email)
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  refreshUserData()
  
  // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  const interval = setInterval(refreshUserData, 30000)
  
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
  onUnmounted(() => {
    clearInterval(interval)
  })
})
</script>

<style scoped lang="scss">
@import '@/styles/design-system/index';

.pending-approval-page {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--color-warning-500) 0%, var(--color-warning-700) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-6);
  
  .pending-card {
    max-width: 500px;
    width: 100%;
    text-align: center;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--elevation-high);
    padding: var(--spacing-8);
    
    .pending-icon {
      width: 100px;
      height: 100px;
      background: var(--color-warning-100);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-6);
      
      .v-icon {
        color: var(--color-warning-600);
        font-size: 3rem;
      }
    }
    
    .pending-title {
      color: var(--color-text-primary);
      font-weight: 700;
      margin-bottom: var(--spacing-4);
    }
    
    .pending-message {
      color: var(--color-text-secondary);
      line-height: 1.6;
      margin-bottom: var(--spacing-6);
    }
    
    .pending-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3);
      
      .logout-button {
        background-color: var(--color-text-secondary) !important;
        color: white !important;
        
        &:hover {
          background-color: var(--color-text-primary) !important;
        }
      }
      
      .refresh-button {
        color: var(--color-primary-500) !important;
        border-color: var(--color-primary-500) !important;
        
        &:hover {
          background-color: var(--color-primary-50) !important;
        }
      }
    }
  }
}

// Responsive design
@media (max-width: 600px) {
  .pending-approval-page {
    padding: var(--spacing-4);
    
    .pending-card {
      padding: var(--spacing-6);
      
      .pending-icon {
        width: 80px;
        height: 80px;
        
        .v-icon {
          font-size: 2.5rem;
        }
      }
      
      .pending-title {
        font-size: 1.5rem;
      }
    }
  }
}
</style> 